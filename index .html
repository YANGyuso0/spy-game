<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èª°æ˜¯é–“è«œï½œè¡Œå‹•ç‰ˆå¤šäººé€£ç·š</title>
  <style>
    .modal{
        position:fixed; inset:0; display:none; place-items:center;
        background:rgba(0,0,0,.65); backdrop-filter: blur(2px); z-index:9999;
      }
      .modal.show{ display:grid; }
      .modal-card{
        background:#0f162f; border:1px solid #223058; border-radius:18px;
        padding:16px; width:min(92vw,520px); text-align:center;
        box-shadow:0 10px 30px rgba(0,0,0,.5);
      }
      .modal-card img{ max-width:100%; height:auto; border-radius:12px }
      .modal-card .title{ font-weight:900; font-size:clamp(22px,5vw,28px); margin:8px 0 12px }
    :root{
      --bg:#0b1020; --panel:#11172c; --ink:#e5e7eb; --muted:#9aa3b2;
      --acc:#22c55e; --acc2:#60a5fa; --danger:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 50% -10%,#1b2750,var(--bg));color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid #1f2846;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);margin:12px 0}
    .pad{padding:16px}
    h1{margin:8px 0 6px;font-size:clamp(20px,6vw,28px)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:grid;gap:10px}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700;letter-spacing:.3px;background:#1a2343;color:var(--ink)}
    .btn:hover{filter:brightness(1.06)}
    .btn.acc{background:var(--acc);color:#06240f}
    .btn.alt{background:var(--acc2);color:#061427}
    .btn.ghost{background:#141b35;border:1px solid #233055}
    .btn.danger{background:var(--danger)}
    .btn.warn{background:var(--warn);color:#241600}
    input,select{background:#0d1326;border:1px solid #223058;color:var(--ink);padding:10px 12px;border-radius:12px}
    .hint{font-size:12px;color:var(--muted)}
    .k{font-variant-numeric:tabular-nums}
    .grid{display:grid;gap:10px}
    .pill{display:flex;justify-content:space-between;align-items:center;gap:10px;background:#0f162f;border:1px solid #223058;border-radius:14px;padding:8px 10px}
    .badge{background:#0d1326;border:1px solid #1f2a4a;border-radius:999px;padding:6px 10px;font-weight:700}
    .word{font-size:clamp(24px,8vw,40px);font-weight:900;letter-spacing:.6px;text-align:center}
    .center{display:grid;place-items:center}
    a{color:#93c5fd}
  </style>
  <!-- Firebaseï¼ˆcompat CDNï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card pad">
      <h1>ğŸ•µï¸â€â™€ï¸ èª°æ˜¯é–“è«œï½œè¡Œå‹•ç‰ˆå¤šäººé€£ç·š</h1>
      <div class="hint">æˆ¿ä¸»å»ºç«‹æˆ¿é–“ â†’ åˆ†äº«é€£çµ â†’ ç©å®¶ç”¨æ‰‹æ©Ÿæ‰“é–‹ â†’ æˆ¿ä¸»é–‹å§‹/ä¸‹ä¸€è¼ªï¼šæ¯äººæ‰‹æ©Ÿåªé¡¯ç¤ºè‡ªå·±çš„èº«åˆ†èˆ‡è©ã€‚</div>
    </div>

    <!-- é€£ç·šç‹€æ…‹é¡¯ç¤º -->
    <div class="card pad" id="connectionStatus" style="display:none">
      <div class="row">
        <span class="badge" id="statusText">é€£ç·šä¸­...</span>
        <span class="badge" id="userIdDisplay">ç”¨æˆ¶ID: â€”</span>
      </div>
    </div>

    <!-- å¤§å»³ -->
    <div class="card pad" id="lobby">
      <div class="grid" style="grid-template-columns:1fr;">
        <div class="row">
          <input id="nick" placeholder="ä½ çš„æš±ç¨±ï¼ˆä¾‹ï¼šP3 æˆ–å°æ˜ï¼‰" style="flex:1" />
        </div>
        <div class="row">
          <input id="roomCode" placeholder="æˆ¿è™Ÿï¼ˆä¾‹ï¼šABCDï¼‰" style="width:130px" />
          <button class="btn alt" id="btnCreate">å»ºç«‹æˆ¿é–“</button>
          <button class="btn" id="btnJoin">åŠ å…¥æˆ¿é–“</button>
        </div>
        <div class="hint">æˆ–ç›´æ¥æ‰“é–‹æˆ¿ä¸»åˆ†äº«çš„é€£çµï¼š?room=ABCD</div>
      </div>
    </div>

    <!-- æˆ¿é–“å…§ -->
    <div class="card pad" id="room" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="badge">æˆ¿è™Ÿï¼š<b id="roomIdTxt">â€”</b></span>
          <span class="badge">ä½ æ˜¯ï¼š<b id="iamHost">â€”</b></span>
        </div>
        <div class="row">
          <button class="btn ghost" id="copyLink">è¤‡è£½é€£çµ</button>
          <button class="btn ghost" id="leaveRoom">é›¢é–‹æˆ¿é–“</button>
        </div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr;align-items:start">
        <div class="col">
          <b>ç©å®¶åå–® (<span id="playerCount">0</span> äºº)</b>
          <div class="grid" id="playerList"></div>
          <div class="hint">å»ºè­° 4â€“11 äººã€‚æˆ¿ä¸»é–‹å§‹å‰å¯ç­‰å¾…å¤§å®¶åˆ°é½Šã€‚</div>
        </div>
        <div class="col" id="hostPanel" style="display:none">
          <b>æˆ¿ä¸»æ§åˆ¶å°</b>
          <div class="grid">
            <div class="row">
              <label class="row" style="gap:6px"><input type="checkbox" id="useBlank" checked />å«ç™½æ¿(1äºº)</label>
              <span class="badge">å›ºå®š 2 é–“è«œ</span>
            </div>
            <div class="row">
              <select id="pairSelect"></select>
              <button class="btn ghost" id="randPair">éš¨æ©Ÿè©</button>
            </div>
            <div class="row">
              <input id="wordA" placeholder="å¹³æ°‘è© A" style="flex:1"/>
              <input id="wordB" placeholder="é–“è«œè© B" style="flex:1"/>
            </div>
            <div class="row">
              <button class="btn acc" id="startRound">é–‹å§‹æœ¬è¼ª</button>
              <button class="btn warn" id="nextRound">ä¸‹ä¸€è¼ªï¼ˆé‡æ–°ç™¼ç‰Œï¼‹æ–°è©ï¼‰</button>
              <button class="btn danger" id="endGame">çµæŸéŠæˆ²</button>
            </div>
            <div class="hint">é–‹å§‹/ä¸‹ä¸€è¼ªå¾Œï¼šæ¯ä½ç©å®¶çš„æ‰‹æ©Ÿæœƒé¡¯ç¤ºè‡ªå·±çš„èº«åˆ†èˆ‡è©ï¼ˆåªé¡¯ç¤ºå„è‡ªå¯è¦‹çš„è©ï¼‰ã€‚</div>
          </div>
        </div>
      </div>
    </div>

    <!-- å€‹äººèº«åˆ†å¡ï¼ˆç§äººè¦–åœ–ï¼‰ -->
    <div class="card pad" id="myCard" style="display:none">
      <div class="row" style="justify-content:space-between">
        <b>æœ¬è¼ªä½ çš„èº«åˆ†</b>
        <span class="badge k">Round <span id="roundNo">0</span></span>
      </div>
      <div class="col">
        <div class="word" id="myWord">ç­‰å¾…æˆ¿ä¸»é–‹å§‹â€¦</div>
        <div class="row center" style="gap:12px">
          <span class="badge" id="myRole">â€”</span>
          <span class="badge" id="pairHint">â€”</span>
        </div>
        <div class="hint">âš ï¸ æœ¬é åªé¡¯ç¤ºçµ¦ä½ è‡ªå·±ï¼Œè«‹å‹¿è®“ä»–äººçœ‹åˆ°ã€‚</div>
      </div>
    </div>

    <!-- éŠæˆ²çµæŸ -->
    <div class="card pad center" id="theEnd" style="display:none">
      <div class="word">æœ¬å ´å·²çµæŸ</div>
      <a id="backToLobby" class="btn" style="display:inline-grid;place-items:center;width:max-content;margin-top:10px" href="#">è¿”å›å¤§å»³</a>
    </div>
  </div>
  <!-- ç”Ÿæ—¥é©šå–œå½ˆè·³è¦–çª— -->
<div id="surpriseModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="title">ğŸ‰ ç”Ÿæ—¥å¿«æ¨‚ï¼ğŸ‚</div>
    <img id="surpriseImg" src="./pikachu_birthday.png" alt="Happy Birthday">
    <div style="margin-top:12px" class="row center">
      <button class="btn acc" id="closeSurprise">æ”¶åˆ°ï¼</button>
    </div>
  </div>
</div>
<script>
// =============== 1) è©åº«ï¼ˆå¯è‡ªè¡Œæ“´å……æˆ–æ›æˆ 100 çµ„ï¼‰ ===============

const PAIRS = [
  ["å¯æ¨‚","é›ªç¢§"],["ç±ƒçƒ","è¶³çƒ"],["ç«é‹","ç‡’çƒ¤"],["é«˜éµ","å°éµ"],["ç‰›è‚‰éºµ","é™½æ˜¥éºµ"],
  ["æ‰‹æ©Ÿæ®¼","ä¿è­·è²¼"],["å……é›»å™¨","è¡Œå‹•é›»æº"],["éµç›¤","æ»‘é¼ "],["è€³æ©Ÿ","å–‡å­"],["å†°æ·‡æ·‹","åˆ¨å†°"],
  ["é›»é¢¨æ‰‡","å†·æ°£"],["æ´—è¡£æ©Ÿ","çƒ˜è¡£æ©Ÿ"],["ç‰›å¥¶","è±†æ¼¿"],["è›‹ç³•","éºµåŒ…"],["è¥¿ç“œ","å“ˆå¯†ç“œ"],
  ["çœ¼é¡","éš±å½¢çœ¼é¡"],["å¤–å¥—","æ¯›è¡£"],["çŸ­è¤²","é•·è¤²"],["é›¨å‚˜","é›¨è¡£"],["åœ°éµ","å…¬è»Š"],
  ["ä¾¿åˆ©å•†åº—","è¶…å¸‚"],["éº¥ç•¶å‹","è‚¯å¾·åŸº"],["çç å¥¶èŒ¶","ç´…èŒ¶æ‹¿éµ"],["å’–å•¡","å¥¶èŒ¶"],["ç¶ èŒ¶","çƒé¾èŒ¶"],
  ["å£ç½©","é¢ç½©"],["ç‰™åˆ·","ç‰™ç·š"],["æ£‰è¢«","æ¯¯å­"],["æ•é ­","æŠ±æ•"],["åœ°ç“œ","é¦¬éˆ´è–¯"],
  ["è˜‹æœ","é¦™è•‰"],["è‰è“","æ«»æ¡ƒ"],["è‘¡è„","è—è“"],["æ©˜å­","æŸšå­"],["ç•ªèŒ„","å°é»ƒç“œ"],
  ["ç†±ç‹—","æ¼¢å ¡"],["ä¸‰æ˜æ²»","æ½›è‰‡å ¡"],["å£½å¸","ç”Ÿé­šç‰‡"],["ç‰›æ’","è±¬æ’"],["ç‚’é£¯","ç‚’éºµ"],
  ["æ¹¯åœ“","å…ƒå®µ"],["æœˆé¤…","è›‹é»ƒé…¥"],["ç²½å­","é£¯ç³°"],["é‹è²¼","æ°´é¤ƒ"],["æ˜¥æ²","æ½¤é¤…"],
  ["ç¾½æ¯›çƒ","ç¶²çƒ"],["æ’çƒ","æ£’çƒ"],["æ¡Œçƒ","æ’çƒ"],["è·‘æ­¥","å¥èµ°"],["æ¸¸æ³³","æ½›æ°´"],
  ["éœ²ç‡Ÿ","ç™»å±±"],["é‡£é­š","åˆ’èˆ¹"],["æºœå†°","æ»‘é›ª"],["ç‘œä¼½","æ™®æ‹‰æ"],["è·³èˆ","å”±æ­Œ"],
  ["é‹¼ç´","å°æç´"],["å‰ä»–","çƒå…‹éº—éº—"],["é¼“","çˆµå£«é¼“"],["ç¬›å­","è–©å…‹æ–¯é¢¨"],["å£ç´","å°è™Ÿ"],
  ["æ¼«ç•«","å°èªª"],["é›»å½±","é›»è¦–åŠ‡"],["æ–°è","é›œèªŒ"],["å»£æ’­","æ’­å®¢"],["ç¶²é ","APP"],
  ["LINE","å¾®ä¿¡"],["IG","æŠ–éŸ³"],["è‡‰æ›¸","æ¨ç‰¹"],["éƒµä»¶","ç°¡è¨Š"],["é›»è©±","è¦–è¨Š"],
  ["æ©Ÿè»Š","è…³è¸è»Š"],["æ±½è»Š","å…¬è»Š"],["ç«è»Š","æ·é‹"],["é£›æ©Ÿ","é«˜éµ"],["æ¸¡è¼ª","éŠè‰‡"],
  ["ç´…è‰²","æ©˜è‰²"],["è—è‰²","ç´«è‰²"],["ç¶ è‰²","é»ƒè‰²"],["é»‘è‰²","ç™½è‰²"],["é‡‘è‰²","éŠ€è‰²"],
  ["é‹¼ç­†","åŸå­ç­†"],["é‰›ç­†","è Ÿç­†"],["æ©¡çš®æ“¦","ç«‹å¯ç™½"],["ç­†è¨˜æœ¬","è¨˜äº‹æœ¬"],["å°º","é‡è§’å™¨"],
  ["é›»è¦–","æŠ•å½±æ©Ÿ"],["å¹³æ¿","ç­†é›»"],["ç›¸æ©Ÿ","æ”å½±æ©Ÿ"],["éŸ³éŸ¿","éº¥å…‹é¢¨"],["æ»‘é¼ ","è§¸æ§æ¿"],
  ["åºŠ","æ²™ç™¼"],["æ¤…å­","æ¿å‡³"],["æ›¸æ¡Œ","é¤æ¡Œ"],["è¡£æ«ƒ","é‹æ«ƒ"],["é¡å­","çª—æˆ¶"],
  ["è¶…äºº","è™è ä¿ "],["èœ˜è››äºº","é‹¼éµäºº"],["ç¶ å·¨äºº","é›·ç¥"],["ç¾å°‘å¥³æˆ°å£«","åº«æ´›é­”æ³•ä½¿"],["ä¸ƒé¾ç ","èˆªæµ·ç‹"]
];
let lastUsedPairIndex = -1;

// æŠ½ä¸‹ä¸€çµ„ï¼ˆé¿å…è·Ÿä¸Šä¸€çµ„ç›¸åŒï¼‰
function pickNextPairIndex(prevIdx) {
  if (PAIRS.length <= 1) return 0;
  let i;
  do { i = Math.floor(Math.random() * PAIRS.length); } while (i === prevIdx);
  return i;
}

// =============== 2) Firebase åˆå§‹åŒ– ===============
const firebaseConfig = {
  apiKey: "AIzaSyAspeuMvQ4VHn4DhoMZW9ittGPQrEmo5Wk",
  authDomain: "spygames-48c3a.firebaseapp.com",
  projectId: "spygames-48c3a",
  storageBucket: "spygames-48c3a.firebasestorage.app",
  messagingSenderId: "1012977219665",
  appId: "1:1012977219665:web:476a9313dd59a9e4f6a070",
  measurementId: "G-PY0PP7D8XJ"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// =============== 3) å°å·¥å…· ===============
const $ = id => document.getElementById(id);
function code4(){ return Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,4) }
function uid(){ return auth.currentUser?.uid }
function now(){ return firebase.firestore.FieldValue.serverTimestamp() }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]] } return arr }

// =============== 4) UI åˆå§‹ ===============
(function initUI(){
  const sel = $('pairSelect');
  PAIRS.forEach((p,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=p[0]+"ï¼"+p[1]; sel.appendChild(o) });
  sel.value=0; $('wordA').value=PAIRS[0][0]; $('wordB').value=PAIRS[0][1];
})();
$('pairSelect').onchange = e=>{ const [a,b]=PAIRS[+e.target.value]; $('wordA').value=a; $('wordB').value=b }
$('randPair').onclick = ()=>{ const i=(Math.random()*PAIRS.length)|0; $('pairSelect').value=i; const [a,b]=PAIRS[i]; $('wordA').value=a; $('wordB').value=b }

// =============== 5) åŒ¿åç™»å…¥ ===============
auth.onAuthStateChanged(user => {
  if (user) {
    $('connectionStatus').style.display = 'block';
    $('statusText').textContent = 'å·²é€£ç·š';
    $('userIdDisplay').textContent = `ç”¨æˆ¶ID: ${user.uid.slice(-6)}`;
    const q = new URLSearchParams(location.search);
    if(q.get('room')) {
      $('roomCode').value = q.get('room').toUpperCase();
      const nick = $('nick').value.trim() || 'ç©å®¶';
      joinRoom(q.get('room').toUpperCase(), nick);
    }
  } else {
    auth.signInAnonymously().catch(console.error);
  }
});

// =============== 6) å»ºç«‹/åŠ å…¥æˆ¿é–“ ===============
$('btnCreate').onclick = async()=>{
  if (!auth.currentUser) { alert('è«‹ç­‰å¾…ç™»å…¥å®Œæˆ...'); return; }
  const nick = $('nick').value.trim() || 'ç©å®¶';
  let code = $('roomCode').value.trim().toUpperCase() || code4();
  if(code.length<2) code=code4();

  const roomRef = db.collection('rooms').doc(code);
  const snap = await roomRef.get();
  if(snap.exists){ alert('æˆ¿è™Ÿå·²å­˜åœ¨ï¼Œè«‹æ›ä¸€å€‹'); return }

  await roomRef.set({
    code, host: uid(), status:'lobby', round:0,
    createdAt: now(), updatedAt: now(),
    players: {}
  });
  await roomRef.update({
    [`players.${uid()}`]: { name:nick, joinedAt: now(), ready:false },
    updatedAt: now()
  });
  joinRoom(code, nick);
};

$('btnJoin').onclick = async()=>{
  if (!auth.currentUser) { alert('è«‹ç­‰å¾…ç™»å…¥å®Œæˆ...'); return; }
  const code = $('roomCode').value.trim().toUpperCase();
  const nick = $('nick').value.trim() || 'ç©å®¶';
  if(!code){ alert('è«‹è¼¸å…¥æˆ¿è™Ÿ'); return }
  joinRoom(code, nick);
};

async function joinRoom(code, nick){
  if (!auth.currentUser) return;
  const roomRef = db.collection('rooms').doc(code);
  const snap = await roomRef.get();
  if(!snap.exists){ alert('æ‰¾ä¸åˆ°æ­¤æˆ¿è™Ÿ'); return }
  try {
    await roomRef.update({
      [`players.${uid()}`]: { name:nick, joinedAt: now(), ready:false },
      updatedAt: now()
    });
    startRoomListener(code);
  } catch (error) {
    console.error('åŠ å…¥æˆ¿é–“å¤±æ•—:', error);
    alert('åŠ å…¥æˆ¿é–“å¤±æ•—: ' + error.message);
  }
}

$('leaveRoom').onclick = async()=>{
  if(!currentRoom || !auth.currentUser) return;
  try {
    const roomRef = db.collection('rooms').doc(currentRoom);
    await roomRef.update({ [`players.${uid()}`]: firebase.firestore.FieldValue.delete(), updatedAt: now() });
    stopRoomListener();
    location.href = location.pathname;
  } catch (error) {
    console.error('é›¢é–‹æˆ¿é–“å¤±æ•—:', error);
  }
};

$('copyLink').onclick = async()=>{
  const url = location.origin + location.pathname + '?room=' + currentRoom;
  try { await navigator.clipboard.writeText(url); alert('é€£çµå·²è¤‡è£½ï¼š\n' + url); }
  catch { prompt('è«‹æ‰‹å‹•è¤‡è£½é€£çµ:', url); }
};

let unsub = null; let currentRoom = null; let isHost = false; let roomData = null;

function stopRoomListener(){ if(unsub){ unsub(); unsub=null; } }

function startRoomListener(code){
  stopRoomListener(); currentRoom = code;
  unsub = db.collection('rooms').doc(code).onSnapshot(snap=>{
    if(!snap.exists){ alert('æˆ¿é–“å·²è¢«åˆªé™¤'); location.href = location.pathname; return; }
    roomData = snap.data();
    isHost = roomData.host === uid();

    // âœ¨ å¾é›²ç«¯åŒæ­¥ä¸Šä¸€çµ„è©çš„ç´¢å¼•ï¼Œä¿è­‰ä¸‹ä¸€è¼ªä¸é‡è¦†
    lastUsedPairIndex = typeof roomData.pairIndex === 'number' ? roomData.pairIndex : -1;

    renderRoom();
    renderMyCard();
    maybeShowSurprise();   // ğŸ‚ ç¬¬10å›åˆè‡ªå‹•å½ˆå‡ºç”Ÿæ—¥åœ–
  }, error => console.error('ç›£è½æˆ¿é–“å¤±æ•—:', error));
}

function renderRoom(){
  if (!roomData) return;
  $('lobby').style.display = 'none';
  $('room').style.display  = 'block';
  $('roomIdTxt').textContent = roomData.code;
  $('iamHost').textContent = isHost? 'æˆ¿ä¸»' : 'ç©å®¶';
  $('hostPanel').style.display = isHost? 'block':'none';

  const box = $('playerList'); box.innerHTML='';
  const players = roomData.players || {};
  const entries = Object.entries(players);
  $('playerCount').textContent = entries.length;

  entries.forEach(([pid,info],idx)=>{
    const div=document.createElement('div'); div.className='pill';
    const you = pid===uid()? 'ï¼ˆä½ ï¼‰' : '';
    const hostMark = pid===roomData.host ? 'ğŸ‘‘' : '';
    div.innerHTML = `<div class="row"><span class="badge">${info.name||'ç©å®¶'}</span> <span class="hint">#${idx+1} ${hostMark}${you}</span></div>`;
    box.appendChild(div);
  });

  $('theEnd').style.display = roomData.status==='end'? 'block':'none';
}

function renderMyCard(){
  if (!roomData || !auth.currentUser) return;
  const show = roomData.status==='reveal' || roomData.status==='play';
  $('myCard').style.display = show? 'block':'none';
  if(!show) return;

  $('roundNo').textContent = roomData.round||0;
  const assignment = roomData.assignments?.[uid()];
  if(!assignment){
    $('myWord').textContent = 'ç­‰å¾…æˆ¿ä¸»é–‹å§‹â€¦';
    $('myRole').textContent = 'â€”';
    $('pairHint').textContent = 'â€”';
    return;
  }
  $('myWord').textContent = assignment.word || 'ï¼ˆç©ºç™½ï¼‰';
  $('myRole').textContent =
    assignment.role === 'SPY' ? 'ğŸ•µï¸ é–“è«œ' :
    assignment.role === 'BLANK' ? 'âšª ç™½æ¿' : 'ğŸ‘¤ å¹³æ°‘';
  // ä¸é¡¯ç¤º A/B è©åº«ï¼Œé¿å…ä½œå¼Š
  $('pairHint').textContent = '_';
}

// =============== ğŸ‚ ç”Ÿæ—¥é©šå–œè¨­å®š ===============
const SURPRISE_ROUND = 10;  // ç¬¬å¹¾å›åˆè§¸ç™¼

function showSurprise(){
  $('surpriseModal').classList.add('show');
  $('surpriseModal').setAttribute('aria-hidden','false');
}
function hideSurprise(){
  $('surpriseModal').classList.remove('show');
  $('surpriseModal').setAttribute('aria-hidden','true');
}
$('closeSurprise').onclick = hideSurprise;

// æ¯å€‹äººåªå½ˆä¸€æ¬¡ï¼šç”¨ localStorage è¨˜éŒ„
function maybeShowSurprise(){
  if (!roomData) return;
  const shouldShow =
    (roomData.round === SURPRISE_ROUND) &&
    (roomData.status === 'reveal' || roomData.status === 'play');
  if (!shouldShow) return;

  const key = `surprise:${currentRoom}:${SURPRISE_ROUND}`;
  if (!localStorage.getItem(key)) {
    localStorage.setItem(key, '1');
    showSurprise();
  }
}

// =============== 7) æˆ¿ä¸»æ§åˆ¶ï¼šé–‹å§‹/ä¸‹ä¸€è¼ª/çµæŸ ===============
$('startRound').onclick = ()=> hostStartOrNext(false);
$('nextRound').onclick  = ()=> hostStartOrNext(true);
$('endGame').onclick    = async()=>{
  if(!confirm('çµæŸé€™å ´éŠæˆ²ï¼Ÿ')) return;
  try {
    await db.collection('rooms').doc(currentRoom).update({ status:'end', updatedAt: now() });
  } catch (error) { console.error('çµæŸéŠæˆ²å¤±æ•—:', error); }
};

async function hostStartOrNext(isNext){
  if(!isHost) { alert('åªæœ‰æˆ¿ä¸»å¯æ“ä½œ'); return; }
  if(!roomData || !currentRoom) return;

  const players = roomData.players || {};
  const playerIds = Object.keys(players);
  const n = playerIds.length;
  if(n < 2) { alert(`è‡³å°‘éœ€è¦ 2 äººï¼Œç›®å‰ ${n} äºº`); return; }
  if(n > 11 && !confirm(`ç›®å‰ ${n} äººï¼Œå»ºè­°ä¸è¶…é 11 äººï¼Œä»è¦é–‹å§‹å—ï¼Ÿ`)) return;

  let A, B, pairIndex = lastUsedPairIndex;

  if (isNext) {
    // âœ… ä¸‹ä¸€è¼ªä¸€å®šæ›è©ï¼šé¿é–‹ä¸Šä¸€çµ„
    pairIndex = pickNextPairIndex(lastUsedPairIndex);
    [A, B] = PAIRS[pairIndex];
    // åŒæ­¥æˆ¿ä¸»é¢æ¿
    $('pairSelect').value = String(pairIndex);
    $('wordA').value = A;
    $('wordB').value = B;
  } else {
    // âœ… é–‹å§‹æœ¬è¼ªï¼šä½¿ç”¨æˆ¿ä¸»é¢æ¿ç›®å‰çš„è©
    A = $('wordA').value.trim();
    B = $('wordB').value.trim();
    const currentIndex = parseInt($('pairSelect').value, 10);
    if (!Number.isNaN(currentIndex)) pairIndex = currentIndex;
  }

  const useBlank = $('useBlank').checked;
  if(!A || !B) { alert('è«‹å¡«å¥½å…©å€‹è©'); return; }

  // é…ç™¼èº«åˆ†
  const shuffled = shuffle([...playerIds]);
  let spyCount = n <= 4 ? 1 : 2;    // 4äººåŠä»¥ä¸‹ï¼š1 é–“è«œï¼›å¦å‰‡ 2
  const spies = shuffled.splice(0, spyCount);
  const blank = (useBlank && shuffled.length > 0) ? shuffled.shift() : null;

  const assignments = {};
  playerIds.forEach(id => {
    if(spies.includes(id)) assignments[id] = { role:'SPY',    word:B };
    else if(blank && id===blank) assignments[id] = { role:'BLANK',  word:'' };
    else assignments[id] = { role:'CIVILIAN', word:A };
  });

  // âœ… å¯«å› pairIndexï¼ˆåªå­˜ç´¢å¼•ï¼Œä¸å­˜è©æœ¬èº«ï¼‰
  await db.collection('rooms').doc(currentRoom).update({
    status:'reveal',
    round:(roomData.round || 0) + 1,
    hasBlank: useBlank,
    assignments,
    pairIndex,                 // åªå­˜ç´¢å¼•ï¼Œé¿å…æ´©æ¼è©
    updatedAt: now()
  });

  lastUsedPairIndex = pairIndex;    // æœ¬åœ°åŒæ­¥
}

// ä¾¿åˆ©ï¼šè¿”å›å¤§å»³
$('backToLobby').onclick = (e)=>{ e.preventDefault(); location.href = location.pathname }
</script>
</body>
</html>
